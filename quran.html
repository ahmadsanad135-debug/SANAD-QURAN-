<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مصحف سند - القراءة والتفسير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --dark-green: #062c1a;
            --mid-green: #0f5132;
            --gold: #c5a059;
            --cream: #fdfdfb;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f4f4f2;
            margin: 0;
            padding-bottom: 220px;
            color: #222;
        }

        /* الهيدر الفخم */
        header {
            background: linear-gradient(to bottom, var(--dark-green), var(--mid-green));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--gold);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .header-title { font-family: 'Amiri', serif; font-size: 1.8rem; font-weight: bold; color: var(--gold); }
        .nav-btn { color: white; text-decoration: none; border: 1px solid var(--gold); padding: 5px 15px; border-radius: 5px; font-size: 0.9rem; transition: 0.3s; }
        .nav-btn:hover { background: var(--gold); color: var(--dark-green); }

        .container { max-width: 900px; margin: 30px auto; padding: 0 15px; }

        /* صندوق السورة */
        .surah-card {
            background: var(--cream);
            border-radius: 15px;
            padding: 40px 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid #e2e2e2;
            position: relative;
            text-align: center;
        }

        .surah-info-tag {
            background: var(--dark-green);
            color: var(--gold);
            padding: 5px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: inline-block;
            border: 1px solid var(--gold);
        }

        .basmala {
            font-family: 'Amiri', serif;
            font-size: 2.2rem;
            color: var(--mid-green);
            margin: 20px 0 40px;
            display: block;
        }

        /* نص الآيات */
        .quran-text {
            line-height: 2.8;
            direction: rtl;
        }

        .ayah-wrapper { display: inline; cursor: pointer; transition: 0.2s; }
        .ayah-wrapper:hover { background: #fff9e6; }

        .ayah-text {
            font-family: 'Amiri', serif;
            font-size: 2.3rem;
            color: #111;
            word-spacing: 2px;
        }

        .ayah-num {
            font-family: 'Amiri', serif;
            font-size: 1.2rem;
            color: var(--mid-green);
            border: 1px solid var(--gold);
            border-radius: 50%;
            width: 35px; height: 35px;
            display: inline-flex;
            align-items: center; justify-content: center;
            margin: 0 8px;
            background: white;
            font-weight: bold;
        }

        /* صندوق التفسير */
        #tafsir-box {
            display: none;
            background: #fdf8e9;
            border-right: 5px solid var(--gold);
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            text-align: right;
            font-size: 1.1rem;
            line-height: 1.6;
            color: #444;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* المشغل السفلي */
        .player-bar {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            background: white;
            border-top: 3px solid var(--gold);
            padding: 20px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
            z-index: 1001;
        }

        .player-inner { max-width: 700px; margin: 0 auto; }
        
        .reciter-select {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid #ddd; font-family: 'Tajawal', sans-serif;
            margin-bottom: 15px; font-weight: bold; color: var(--dark-green);
        }

        audio { width: 100%; height: 45px; }

        .controls {
            display: flex; justify-content: center; gap: 50px; margin-top: 15px;
        }

        .btn { background: none; border: none; font-size: 1.8rem; color: #bbb; cursor: pointer; transition: 0.3s; }
        .btn.active { color: var(--gold); }
        .btn:hover { color: var(--mid-green); }

    </style>
</head>
<body>

    <header>
        <a href="index.html" class="nav-btn">الفهرس</a>
        <div id="surah-title" class="header-title">سورة...</div>
        <div style="width: 60px;"></div>
    </header>

    <div class="container">
        <div class="surah-card">
            <div id="surah-info" class="surah-info-tag">جاري التحميل...</div>
            
            <div id="tafsir-box">
                <strong>تفسير الجلالين:</strong><br>
                <span id="tafsir-text">اضغط على الآية لعرض تفسيرها</span>
            </div>

            <div id="quran-container" class="quran-text">
                </div>
        </div>
    </div>

    <div class="player-bar">
        <div class="player-inner">
            <select id="reciter-list" class="reciter-select">
                <option value="https://server14.mp3quran.net/islam/">إسلام صبحي</option>
                <option value="https://server7.mp3quran.net/sds/">عبد الرحمن السديس</option>
                <option value="https://server7.mp3quran.net/basit/">عبد الباسط عبد الصمد</option>
                <option value="https://server12.mp3quran.net/maher/">ماهر المعيقلي</option>
                <option value="https://server8.mp3quran.net/afs/">مشاري العفاسي</option>
                <option value="https://server11.mp3quran.net/yasser/">ياسر الدوسري</option>
            </select>

            <audio id="main-player" controls>
                <source id="audio-src" src="" type="audio/mpeg">
            </audio>

            <div class="controls">
                <button id="next-btn" class="btn" title="السورة التالية"><i class="fas fa-forward-step"></i></button>
                <button id="loop-btn" class="btn" title="تكرار السورة"><i class="fas fa-rotate"></i></button>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const surahNum = params.get('surah') || '1';
        let isLoop = false;

        async function loadSurah() {
            try {
                // 1. جلب نص القرآن (Simple Enhanced لتفادي المربعات)
                const qRes = await fetch(`https://api.alquran.cloud/v1/surah/${surahNum}/editions/quran-simple-enhanced,ar.jalalayn`);
                const data = await qRes.json();
                
                const quranData = data.data[0]; // النص
                const tafsirData = data.data[1]; // التفسير

                // تحديث العناوين
                document.getElementById('surah-title').textContent = `سورة ${quranData.name}`;
                document.getElementById('surah-info').textContent = 
                    `${quranData.revelationType === 'Meccan' ? 'مكية' : 'مدنية'} | ${quranData.numberOfAyahs} آية`;

                // بناء المحتوى
                let html = "";
                
                // البسملة (إخفاء في التوبة والفاتحة)
                if(surahNum != 9 && surahNum != 1) {
                    html += `<div class="basmala">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>`;
                }

                quranData.ayahs.forEach((ayah, index) => {
                    let text = ayah.text;
                    if(surahNum != 1 && surahNum != 9 && ayah.numberInSurah === 1) {
                        text = text.replace('بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ ', '');
                    }

                    // ربط كل آية بتفسيرها عند الضغط
                    html += `
                        <span class="ayah-wrapper" onclick="showTafsir('${tafsirData.ayahs[index].text.replace(/'/g, "\\'")}')">
                            <span class="ayah-text">${text}</span>
                            <span class="ayah-num">${ayah.numberInSurah}</span>
                        </span>
                    `;
                });

                document.getElementById('quran-container').innerHTML = html;
                
                // حفظ آخر سورة
                localStorage.setItem('lastReadSurah', surahNum);
                localStorage.setItem('lastReadName', quranData.name);

                updateAudio();
            } catch (e) {
                console.error(e);
            }
        }

        function showTafsir(text) {
            const box = document.getElementById('tafsir-box');
            document.getElementById('tafsir-text').textContent = text;
            box.style.display = 'block';
            window.scrollTo({ top: box.offsetTop - 100, behavior: 'smooth' });
        }

        function updateAudio() {
            const server = document.getElementById('reciter-list').value;
            const id = surahNum.padStart(3, '0');
            document.getElementById('audio-src').src = `${server}${id}.mp3`;
            document.getElementById('main-player').load();
        }

        document.getElementById('reciter-list').onchange = updateAudio;

        document.getElementById('loop-btn').onclick = function() {
            isLoop = !isLoop;
            this.classList.toggle('active', isLoop);
        };

        document.getElementById('next-btn').onclick = function() {
            const next = parseInt(surahNum) + 1;
            if(next <= 114) window.location.href = `quran.html?surah=${next}`;
        };

        document.getElementById('main-player').onended = function() {
            if(isLoop) { this.play(); } 
            else { document.getElementById('next-btn').click(); }
        };

        loadSurah();
    </script>
</body>
</html>
